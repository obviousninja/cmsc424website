<html>
	<head>
		<title>Nom.com</title>
	</head>
	<body>
		<?php 
			$cid = $_POST["customerid"];
			echo "Get CID: " . $cid . "<br>";
			$_SESSION["cid"] = $_POST["customerid"];
			$_SESSION["searchtext"] = "";

			include 'loggedinheader.php';


			$servername = "localhost";
			$username = "jchen127";
	        $password = "KbZFqBcZCy29b3Lx";
	        $database = "myDB";
			// Create connection
			$conn = mysqli_connect($servername, $username, $password);

			// Check connection
			if (!$conn) {
			    die("Connection failed: " . mysqli_connect_error());
			}

			/* CHECK HERE IF DELIVERY PERSON IS AVAILABLE ON ROUTE!!!!!!!!!!!!!! */

			$cid = $_POST["customerid"];
			$bid = $_POST["basketid"];
			$totalitemcost = $_POST["totalitemcost"];
			$costwithtax = $_POST["costwithtax"];
			$deliverycharge = $_POST["deliverycharge"];
			$tripduration = $_POST["tripduration"];
			$bankaccountnumber = $_POST["bankaccountnumber"];
			$bankroutingnumber = $_POST["bankroutingnumber"];
			$standingordertype = $_POST["standingordertype"];
			echo "Standing Order Type: " . $standingordertype . "<br>";

			$totaltransactioncost = $costwithtax + $deliverycharge;

			$date = date('Y-m-d H:i:s', time());
			echo "DATE: " . $date . "<br>";
			echo "DURATION: " . $tripduration . "<br>";
			$timeofarrival = date("Y-m-d H:i:s", time() + $tripduration);
			echo "Estimated Time of Delivery: " . $timeofarrival . "<br>";

			$sql = "UPDATE $database.customer SET bankaccountnumber = '$bankaccountnumber', bankroutingnumber = '$bankroutingnumber' WHERE customerid = $cid";
			$result = mysqli_query($conn, $sql);

			/* Make bill */
			if (!$result) {
				echo "Update of customer failed!<br>";
			} else {
			    echo "Customer update success!<br>";

			    if ($standingordertype != "None") {
			    	echo "IsStandingOrder is true<br>";
			    	$sqlStanding = "UPDATE $database.basket SET isstandingorder = 1, standingordertype = '$standingordertype' WHERE basketid = $bid";
			    	$resultStanding = mysqli_query($conn, $sqlStanding);

			    	if (!$resultStanding) {
			    		echo "Update of basket to standing order failed!<br>";
			    	} else {
			    		echo "Successfully set basket to standing order!<br>";
			    	}
			    }

			    $sqlTrans = "INSERT INTO $database.transaction VALUES (NULL, $bid, $cid, $totaltransactioncost, 1, '$date', '$timeofarrival', NULL)";
			    $resultTrans = mysqli_query($conn, $sqlTrans);

			    if (!$resultTrans) {
			    	echo "Insertion of transaction failed!<br>";
			    } else {
			    	echo "Transaction insertion success!<br>";

				    $sqlGetTransID = "SELECT transactionid FROM $database.transaction WHERE basketid = $bid";
				    $resultGetTransID = mysqli_query($conn, $sqlGetTransID);

				    if ($resultGetTransID && mysqli_num_rows($resultGetTransID) > 0) {
				    	$transID = -1;
					    // output data of each row
					    while($row = mysqli_fetch_assoc($resultGetTransID)) {
					    	$transID = $row["transactionid"];
					    	echo "Found transID: " . $transID . "<br>";
					    }

					    $sqlBill = "INSERT INTO $database.bill VALUES (NULL, $transID, $totalitemcost, $costwithtax, $deliverycharge, NULL, 0)";
					    $resultBill = mysqli_query($conn, $sqlBill);

					    if (!$resultBill) {
					    	echo "Insertion of bill failed!<br>";
					    } else {
					    	echo "Bill insertion success!<br>";
					    	echo mysql_info() . "<br>";

					    	/* Update customer balance and set new current basket */
					    	$sqlBasket = "INSERT INTO $database.basket VALUES (NULL, $cid, 0, NULL, 0, '$date')"; 
					    	$resultBasket = mysqli_query($conn, $sqlBasket);

					    	if (!$resultBasket) {
					    		echo "Basket creation failed!<br>";
					    	} else {
					    		echo "Basket creation successful!<br>";

					    		$sqlBalance = "UPDATE $database.customer SET balance = balance - $totaltransactioncost, currentbasket = LAST_INSERT_ID() WHERE customerid = $cid";
					    		$resultBalance = mysqli_query($conn, $sqlBalance);

					    		if ($resultBalance) {
					    			echo "Balance update successful!<br>";

					    			/* update product count??!!!!!!!!!!!!!!!! 
					    			$sqlProduct = "UPDATE $database.product SET soldcount = soldcount + ?? WHERE productid in (SELECT productid, productquantity FROM $database.basketitem bi WHERE bi.basketid = $bid)";
					    			$resultProduct = mysqli_query($conn, $sqlProduct);

					    			if ($resultProduct && mysqli_num_rows($resultProduct) > 0) {

					    			} else {
					    				echo "No products updated<br>";
					    			}*/

					    		} else {
					    			echo "Balance and currentbasket update failed!<br>";
					    		}
					    	}
					    }
					} else {
						echo "Finding transaction ID failed!<br>";
					}
				}
			}

			mysqli_close($conn);
		?>


	</body>
</html>
